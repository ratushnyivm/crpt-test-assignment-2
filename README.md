# crpt-test-assignment-2

---

## Описание

[Скрипт](https://github.com/ratushnyyvm/crpt-test-assignment-2/blob/main/process_document.py) для обработки документов и связанных с ними объектов.

---

## Зависимости

| Tool                              | Version    |
|-----------------------------------|------------|
| python                            | "^3.11"    |
| python-dotenv                     | "^1.0.0"   |
| psycopg2-binary                   | "^2.9.7"   |

---

## Установка

Данный скрипт можно использовать без установки проекта.

Если установка необходима, убедитесь, что у вас установлены [Python](https://www.python.org/), [Poetry](https://python-poetry.org/) и [PostgreSQL](https://www.postgresql.org/).

```bash
# Проверить версию python
python3 -V

# Проверить версию poetry
poetry -V

# Установить poetry
curl -sSL https://install.python-poetry.org | python3 -
```

1. Склонируйте данный репозиторий и перейдите в папку проекта:

    ```bash
    git clone https://github.com/ratushnyyvm/crpt-test-assignment-2.git && cd crpt-test-assignment-2
    ```

2. Установите все необходимые зависимости:

    ```bash
    poetry install
    ```

3. Переименуйте файл `.env.example` в `.env` и заполните указанные поля. Либо создайте новый файл `.env` со следующими данными:

    ```bash
    POSTGRES_DB=
    POSTGRES_USER=
    POSTGRES_PASSWORD=
    POSTGRES_HOST=
    POSTGRES_PORT=
    ```

4. Запустите скрипт:

    ```bash
    poetry run python3 process_document.py 
    ```

---

## Использование

Для работы скрипта необходимы две таблицы: documents и data.

```bash
CREATE TABLE IF NOT EXISTS public.documents
(
    doc_id character varying COLLATE pg_catalog."default" NOT NULL,
    recieved_at timestamp without time zone,
    document_type character varying COLLATE pg_catalog."default",
    document_data jsonb,
    processed_at timestamp without time zone,
    CONSTRAINT documents_pkey PRIMARY KEY (doc_id)
)
```

```bash
CREATE TABLE IF NOT EXISTS public.data
(
    object character varying(50) COLLATE pg_catalog."default" NOT NULL,
    status integer,
    level integer,
    parent character varying COLLATE pg_catalog."default",
    owner character varying(14) COLLATE pg_catalog."default",
    CONSTRAINT data_pkey PRIMARY KEY (object)
)
```

Скрипт состоит из четырех условных частей:

1. Константы для подключения к базе данных
2. Класс для работы с базой данных
3. Класс для работы с документом и связанными с ним объектами
4. Функция, реализующая последовательность выполнения шагов алгоритма

Шаги алгоритма:

1. Получение документа по определенным заданием условиям
2. Валидация операций, которые требуется произвести над объектами
3. Получение объектов, которые связаны с документом и требуют внесения изменений
4. Обновление объектов из пункта 3
5. Проставление метки о проведении обработки документа

Так как пункты 1 и 5 взаимоисключающие, скрипт продолжит обрабатывать остальные документы, удовлетворяющие условиям. Остановка работы скрипта происходит либо при возникновении ошибки, либо при обработке всех документов.

Ниже приведены примеры часто встречающихся логов во время обработки документов.

Вариант, при котором у документа есть объекты в поле `objects`, `operation_details` являются валидными, а в таблице `data` присутствуют подходящие для изменения объекты:

```bash
2023-08-20 13:47:51 :: INFO :: Документ [id = 82551572-cf2d-4037-8427-30327f786650] успешно получен
2023-08-20 13:47:51 :: INFO :: Поля, требующие изменений, успешно провалидированы
2023-08-20 13:47:51 :: INFO :: Объекты, требующие изменений, успешно получены
2023-08-20 13:47:51 :: INFO :: Все объекты, связанные с документом [id = 82551572-cf2d-4037-8427-30327f786650], успешно обновлены
2023-08-20 13:47:51 :: INFO :: Дата и время обновления документа [id = 82551572-cf2d-4037-8427-30327f786650] успешно установлены
```

Вариант, при котором в таблице `data` отсутствуют объекты, удовлетворяющие условиям изменения:

```bash
2023-08-20 13:47:51 :: INFO :: Документ [id = c173dbe1-2855-413e-bf1c-4b941a0aabce] успешно получен
2023-08-20 13:47:51 :: INFO :: Поля, требующие изменений, успешно провалидированы
2023-08-20 13:47:51 :: INFO :: Объекты, требующие изменений, не найдены
2023-08-20 13:47:51 :: INFO :: Обновление пропущено, так как отсутствуют подходящие объекты и/или детали операции.
2023-08-20 13:47:51 :: INFO :: Дата и время обновления документа [id = c173dbe1-2855-413e-bf1c-4b941a0aabce] успешно установлены
```

Вариант, при котором у выбранного документа отсутствуют связанные объекты в поле `objects`:

```bash
2023-08-20 13:47:51 :: INFO :: Документ [id = 210eaceb-1575-4a90-b950-9df2f4ed6e50] успешно получен
2023-08-20 13:47:51 :: INFO :: Поля, требующие изменений, успешно провалидированы
2023-08-20 13:47:51 :: INFO :: Документ [id = 210eaceb-1575-4a90-b950-9df2f4ed6e50] не содержит ссылок на другие объекты
2023-08-20 13:47:51 :: INFO :: Обновление пропущено, так как отсутствуют подходящие объекты и/или детали операции.
2023-08-20 13:47:51 :: INFO :: Дата и время обновления документа [id = 210eaceb-1575-4a90-b950-9df2f4ed6e50] успешно установлены
```

Сообщения об отсутствии подходящих для изменения документов и остановке работы скрипта:

```bash
2023-08-20 13:47:51 :: INFO :: Документ, требующий внесения изменений, не обнаружен
2023-08-20 13:47:51 :: INFO :: Выполнение скрипта остановлено
```

---

[:arrow_up: ВВЕРХ :arrow_up:](#crpt-test-assignment-2)
